name: Publish

on:
    create:
        tags:
            - "v*"

env:
    CARGO_INCREMENTAL: 0
    CARGO_PROFILE_RELEASE_LTO: "fat"

jobs:
    build:
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true
                  components: rustfmt, clippy

            - run: cargo check --color always --all --all-targets
            - run: cargo fmt --check --all
            - run: cargo clippy --color always --all --all-targets
            - run: cargo test --color always --all --all-targets

            - name: publish crates
              run: cargo publish --token ${CRATES_TOKEN}
              env:
                  CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}
